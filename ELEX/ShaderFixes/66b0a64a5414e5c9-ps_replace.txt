// Coarse blurry shadows

cbuffer _Globals : register(b0)
{
  float3 LightDir : packoffset(c0);
  float4x4 ShadowVolumeTransform : packoffset(c1);
  float4 Unproject : packoffset(c5);
  float4x4 EyeToLightSpace : packoffset(c6);
  float2 CascadeShadowSettings : packoffset(c10);
  float CascadeIndex : packoffset(c10.z);
  float CascadeShadowMapSize : packoffset(c10.w);
  float2 RcpDeferredShadowMapSize : packoffset(c11);
}

// Copied in with 3Dmigoto
cbuffer _CommonMatrices : register(b1)
{
  float4x4 m_matViewProjection;
  float4x4 m_matInvProjection;
  float4x4 m_matProjection;
  float4x4 m_matView;
  float4x4 m_matCameraViewProjection;
  float4x4 m_matCameraProjection;
  float4 m_frustumPlanes[6];
  float3 m_vecCamPos;
  float m_fFar;
  float3 m_vecWorldCamPos;
  float m_fRcpFar;
  float3 m_vecRenderOffset;
  float m_fNear;
  float3 m_vecCamDir;
  float m_fExposure;
  float2 m_vecViewPortSize;
  float2 m_vecRcpViewPortSize;
  float2 m_vecDistortionScale;
  float m_fFoV;
  float _padding0;
  float m_fCamAzimuth;
  float m_fTime;
  float m_fFrameTime;
  float m_fAdaptiveTessellationFactor;
  float2 m_vecMiePhaseConstants;
  float m_fOceanWaterLevel;
  float m_fRenderOffsetOceanWaterLevel;
  float4 m_vecOceanColorAndOpacity;
  float2 m_vecOceanTexCoordScale;
  float2 m_vecRcpOceanTexCoordScale;
  float m_fWeatherTemperature;
  float2 m_vecZToDepth;
  float _padding1;
  float3 m_vecSunDir;
  float _padding2;
}

SamplerState SmpClampLin_s : register(s0);
Texture2D<float> LinearDepth : register(t0);
Texture2DArray<float2> VarianceShadowMap : register(t1);


// 3Dmigoto declarations
#define cmp -
Texture1D<float4> IniParams : register(t120);
Texture2D<float4> StereoParams : register(t125);


void main(
  float4 v0 : SV_Position0,
  out float2 o0 : SV_Target0)
{
  float4 r0,r1,r2;
  uint4 bitmask, uiDest;
  float4 fDest;

  r0.z = CascadeIndex;
  r1.xy = (int2)v0.xy;
  r1.zw = float2(0,0);
  r1.z = LinearDepth.Load(r1.xyz).x;
  r2.xy = v0.xy * Unproject.xy + Unproject.zw;
  r1.xy = r2.xy * r1.zz;

// Fix shadows
float4 stereo = StereoParams.Load(0);
r1.x -= stereo.x * (r1.z - stereo.y / m_fFar) * m_matInvProjection._m00;

  r1.w = 1;
  r0.x = dot(r1.xyzw, EyeToLightSpace._m00_m10_m20_m30);
  r0.y = dot(r1.xyzw, EyeToLightSpace._m01_m11_m21_m31);
  r0.w = dot(r1.xyzw, EyeToLightSpace._m02_m12_m22_m32);
  r0.xy = VarianceShadowMap.SampleLevel(SmpClampLin_s, r0.xyz, 0).xy;
  r0.z = r0.x + -r0.w;
  r0.w = cmp(r0.x >= r0.w);
  r0.x = saturate(-r0.x * r0.x + r0.y);
  r0.x = 9.99999975e-06 + r0.x;
  r0.x = min(1, r0.x);
  r0.y = r0.w ? 1.000000 : 0;
  r0.z = r0.z * r0.z + r0.x;
  r0.x = r0.x / r0.z;
  r0.x = -0.699999988 + r0.x;
  r0.x = saturate(3.33333325 * r0.x);
  o0.xy = max(r0.xx, r0.yy);
  return;
}
